
// Allow GitHub image rendering
:imagesdir: ../../images

=== GraphML Asset Plugin

==== Overview

The _GraphML Asset Plugin_ generates an _{opennms-product-name}_ GraphML topology based upon the contents of the Node Asset table. 

_{opennms-product-name}_ uses graphml (see http://graphml.graphdrawing.org/) to define complex topologies. The details of how _{opennms-product-name}_ interprets graphml are given in the graphml section of the _{opennms-product-name}_ developers guide. 

Creating a usable topology for a large network can be a complex task for a user and so this plugin greatly simplifies the task for many use cases by allowing users to define fields in the Node Asset table which will enable nodes to be positioned correctly in a complex topology. The structure of the generated GraphML topology is determined by the `assetLayers` configuration constant which can be set by a user. To illustrate how this works, we will consider the following configuration:
----
assetLayers=asset-region,asset-building
----
The _{opennms-product-name}_ Asset table is parsed to generate nested layers in the order of the comma separated keys in this property.
Each layer is a graphml graph which is named after the key. Graphml nodes in each layer reference related Graphml nodes in the underlying layer. The lowest layer contains Graphml nodes which are directly linked to real _{opennms-product-name}_ nodes.

The following diagram shows the structure of a topology generated by the above `assetLayers` property

image:plugins/graphMLtopologyLayers.jpg[Illustrating how node asset entries are interpreted as layers]

In this example the `region` asset fields for node 1,2,3,4 are set to north. All of these nodes are in the same north region. The `building` asset fields for Node 1 and Node 2 are set to 21 (both nodes are in building 21) while the The `building` asset fields for Node 3 and Node 4 are set to 22 (both nodes are in building 22). 

The _GraphML Asset Plugin_ generates 4 linked graphs for this configuration. The layer 0 graph is called `asset-region`, the layer 1 graph is called `asset-building` and the layer 2 graph is called `nodes`. Another graph is also generated called `unallocated-nodes` which contains all of the _{opennms-product-name}_ nodes which cannot be placed in the topology.

Conceptually we can see that the topology is rendered as concentric sets. The _GraphML Asset Plugin_ first searches all of the nodes with regions defined and creates a new level 0 node representing each region found. The _GraphML Asset Plugin_ then searches within each region to find the building entries and creates a corresponding level 1 node for each building name found. Finally the _GraphML Asset Plugin_ creates layer 2 nodes corresponding to each _{opennms-product-name}_ Node and places each in the correct building. If however _{opennms-product-name}_ Nodes are found which have either the region or building asset fields empty they cannot be placed correctly in this topology. These nodes are therefore placed in another level 0 graph for `unallocated nodes`. Finally, only building and region nodes are generated which can be linked to _{opennms-product-name}_ nodes in the topology. The _GraphML Asset Plugin_ does not generate spurious graphml nodes in upper layers which are not directly and completely referenced by _{opennms-product-name}_ nodes in the lowest layer.

==== Configuration
The configuration for the GraphML Asset Plugin is held in the following file
----
<opennms home>/etc/org.opennms.plugins.graphml.asset.cfg
----
Which contains the following properties (defaults shown will be used if the file is not present)


[options="header, autowidth"]
|===
| Parameter                 | Default               | Description
|`baseUrl`  | http://localhost:8980 | address of ReST interface
|`basePath` | /opennms/rest | base path to  ReST interface
|`userName` | admin | username to accesses  ReST interface
|`password` | admin | password to access ReST interface
|`assetLayers`| asset-region,asset-building,asset-rack  | asset layers (in order). See separate description.
|`preferredLayout` | Grid Layout | Preferred layout of the nodes in generated graphml graphs. 
|`writeAssetListDebugFile` | true | If true an xml file is written called AssetListFile.xml containing all the nodes and associated asset fields. (This file can be used for debugging. A similar file is used in the unit tests for this module).
|===

The entries for `assetLayers` can be any asset entry from the following list (defined in org.opennms.plugins.graphml.asset.NodeParamLabels). Thus arbitrary topologies can be generated based upon asset node categories etc. Please note however you should not put any spaces in the comma separated `assetLayers` list. 
----
node-nodelabel, node-nodeid, node-foreignsource, node-foreignid, node-nodesysname, 
node-nodesyslocation, node-operatingsystem, node-categories, 
parent-nodelabel, parent-nodeid, parent-foreignsource, parent-foreignid, 
asset-country, asset-address1, asset-address2, asset-city, asset-zip, asset-state, 
asset-latitude, asset-longitude, asset-region, asset-division, 
asset-department, asset-building, asset-floor, asset-room, 
asset-rack, asset-slot, asset-port, asset-circuitid, 
asset-category, asset-displaycategory, asset-notifycategory, 
asset-pollercategory, asset-thresholdcategory, asset-managedobjecttype, 
asset-managedobjectinstance, asset-manufacturer, asset-vendor, 
asset-modelnumber, asset-description, asset-operatingsystem
----
If the `assetLayers` property is defined as empty then a single graph layer will be generated containing all opennms nodes.

==== Generating and installing asset based topologies

Once activated, the  _GraphML Asset Plugin_ will generate a new topology file called
----
<opennms-home>/etc/assettopology/AssetTopologyFile.xml
----
However this topology will not be loaded immediately. The _GraphML Asset Plugin_ listens for events which trigger the generation, installation or removal of topologies. 
The _GraphML Asset Plugin_ events are defined in the file
----
<opennms home>/etc/events/GraphMLAssetPluginEvents.xml
----

These events can be used without parameters and the default values shown below will be used. 
Alternatively you can give parameters which set the filename and the topology you wish to generate and/or install or remove.

Create a new topology file from the current OpenNMS inventory. (if topologyFilename is undefined `AssetTopologyFile.xml` is default )
----
sudo ./send-event.pl  uei.opennms.plugins/assettopology/create  -p `topologyFilename AssetTopologyFile.xml'
----

To install an asset topology file
(if topologyName is undefined `assetTopology` is default )
(if topologyFilename is undefined `AssetTopologyFile.xml` is default )
----
sudo ./send-event.pl  uei.opennms.plugins/assettopology/install  -p 'topologyFilename AssetTopologyFile.xml' -p 'topologyName assetTopology'
----

To uninstall an asset topology
(if topologyName is undefined `assetTopology` is default )
----
sudo ./send-event.pl  uei.opennms.plugins/assettopology/uninstall  -p 'topologyName assetTopology'
----

You can alternatively use the _{opennms-product-name}_  graphml ReST api to install the generated graphml file. 
The install and uninstall events are merely convenient alternatives to using the ReST api directly. 

=== Viewing the topology
If all goes well, having installed the topology, upon refreshing your screen, you should see a new topology display option in the _{opennms-product-name}_  topology page. The displayed name of this topology includes the date when the topology was created. This name comes from the label key in the generated topology file. e.g
----
<data key="label">Asset Topology Mon 20.02.2017_04:37:52</data>
----
It is not related to the name of the topology (topologyName) which is used by the ReST api for the installation or removal of a topology. However this name must be unique across all installed topologies. 

It is possible to have several topologies installed which have been generated using different configurations. You simply need to ensure that the topologyName used for each installation command is different.

=== additional notes

Please note you MUST first uninstall an _{opennms-product-name}_ graphml topology before installing a new one. You will also have to log out and log back into the UI in order to see the new topology file. If you uninstall a topology while viewing it, the UI will throw an error and you will also have to log out and back in to see topologies. It can be useful to look at the karaf.log file to see if any problems have occurred when installing or running the plugin. 

 









 
